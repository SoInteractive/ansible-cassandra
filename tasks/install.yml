---

- name: Install dependencies
  package:
    name: python-pip
    state: present

- name: Install pip dependencies
  pip:
    name: docker-py

- name: Install cqlsh on first node
  pip:
    name: cqlsh
  delegate_to: "{{ groups[cassandra_hosts_group][0] }}"
  run_once: true

- name: Make sure data dir exist
  file:
    path: "{{ cassandra_data_dir }}"
    state: directory

- name: Download and run Cassandra instance
  docker_container:
    name: cassandra
    image: "cassandra:{{ cassandra_version }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "7000:7000"
      - "9042:9042"
    volumes:
      - "{{ cassandra_data_dir }}:/var/lib/cassandra:rw"
    env:
      CASSANDRA_SEEDS: "{% for host in groups[cassandra_hosts_group] %}{{ hostvars[host]['cassandra_address'] }}{% if not loop.last %},{% endif %}{% endfor %}"
      CASSANDRA_BROADCAST_ADDRESS: "{{ cassandra_address }}"
      CASSANDRA_CLUSTER_NAME: "{{ cassandra_cluster_name }}"
  notify: tests